{% extends 'base.html' %}
{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-decoration-none">Главная</a></li>
    <li class="breadcrumb-item active">{{ olymp.title }}</li>
  </ol>
</nav>

<div class="row g-4">
  <div class="col-md-8">
    <!-- Информация о соревновании -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2 class="fw-bold mb-0">{{ olymp.title }}</h2>
          
          {% if user.is_authenticated and olymp.creator == user or user.profile.is_admin %}
          <div>
            <a href="{% url 'olymp_edit' olymp.pk %}" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-pencil-square me-1"></i>Редактировать
            </a>
            <a href="{% url 'olymp_delete' olymp.pk %}" class="btn btn-sm btn-outline-danger ms-2">
              <i class="bi bi-trash me-1"></i>Удалить
            </a>
          </div>
          {% endif %}
        </div>
        
        <div class="mb-4">
          <span class="badge bg-secondary rounded-pill mb-2">{{ olymp.subject }}</span>
          
          {% if olymp.difficulty %}
          <span class="badge 
            {% if olymp.difficulty == 'easy' %}bg-success
            {% elif olymp.difficulty == 'medium' %}bg-warning
            {% else %}bg-danger{% endif %} rounded-pill mb-2">
            {% if olymp.difficulty == 'easy' %}Легкий
            {% elif olymp.difficulty == 'medium' %}Средний
            {% else %}Сложный{% endif %}
          </span>
          {% endif %}
          
          <span class="olympiad-status 
            {% if olymp.status == 'active' %}status-active
            {% elif olymp.status == 'upcoming' %}status-upcoming
            {% else %}status-finished{% endif %} mb-2">
            {% if olymp.status == 'active' %}Активно
            {% elif olymp.status == 'upcoming' %}Скоро
            {% else %}Завершено{% endif %}
          </span>
        </div>
        
        <div class="row g-3 mb-4">
          <div class="col-sm-6">
            <div class="card bg-light border-0 h-100">
              <div class="card-body py-3">
                <h6 class="fw-semibold"><i class="bi bi-calendar-event me-2 text-primary"></i>Дата начала</h6>
                <div>{{ olymp.start_at|date:"d.m.Y" }} в {{ olymp.start_at|date:"H:i" }}</div>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="card bg-light border-0 h-100">
              <div class="card-body py-3">
                <h6 class="fw-semibold"><i class="bi bi-calendar-check me-2 text-danger"></i>Дата завершения</h6>
                <div>{{ olymp.end_at|date:"d.m.Y" }} в {{ olymp.end_at|date:"H:i" }}</div>
              </div>
            </div>
          </div>
        </div>
        
        {% if olymp.description %}
        <div class="mb-4">
          <h5 class="fw-semibold mb-2">Описание</h5>
          <p class="text-muted">{{ olymp.description }}</p>
        </div>
        {% endif %}
        
        {% if olymp.rules %}
        <div class="mb-4">
          <h5 class="fw-semibold mb-2">Правила</h5>
          <p class="text-muted">{{ olymp.rules }}</p>
        </div>
        {% endif %}
        
        <!-- Задания соревнования -->
        <div class="mt-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0"><i class="bi bi-list-check me-2 text-primary"></i>Задания</h4>
            
            {% if user.is_authenticated and olymp.creator == user or user.profile.is_admin %}
            <a href="{% url 'problem_create' olympiad_id=olymp.pk %}" class="btn btn-sm btn-success">
              <i class="bi bi-plus-lg me-1"></i>Добавить задание
            </a>
            {% endif %}
          </div>
          
          {% if olymp.problems.all %}
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Название</th>
                  <th>Описание</th>
                  <th class="text-center">Баллы</th>
                  {% if user.is_authenticated and olymp.creator == user or user.profile.is_admin %}
                  <th class="text-end">Действия</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for problem in olymp.problems.all %}
                <tr>
                  <td>
                    <div class="fw-medium">{{ problem.title }}</div>
                    {% if problem.statement_file %}
                    <small class="text-muted">
                      <i class="bi bi-file-earmark me-1"></i>{{ problem.filename }}
                    </small>
                    {% endif %}
                  </td>
                  <td>
                    <div class="text-muted">{{ problem.description|truncatechars:50 }}</div>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-primary rounded-pill">{{ problem.max_score }}</span>
                  </td>
                  {% if user.is_authenticated and olymp.creator == user or user.profile.is_admin %}
                  <td class="text-end">
                    <a href="{% url 'problem_update' problem.pk %}" class="btn btn-sm btn-outline-primary me-1">
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'problem_delete' problem.pk %}" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash"></i>
                    </a>
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4 bg-light rounded">
            <i class="bi bi-info-circle fs-4 mb-3 d-block text-muted"></i>
            <p class="text-muted mb-0">Задания для этого соревнования пока не добавлены</p>
            {% if user.is_authenticated and olymp.creator == user or user.profile.is_admin %}
            <div class="mt-3">
              <a href="{% url 'problem_create' olympiad_id=olymp.pk %}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg me-1"></i>Добавить первое задание
              </a>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        
        <div class="d-flex mt-4">
          {% if is_registered %}
            <a href="{% url 'tasks' pk=olymp.pk %}" class="btn btn-primary">
              <i class="bi bi-arrow-right me-1"></i>Перейти к заданиям
            </a>
          {% else %}
            {% if olymp.status == 'upcoming' or olymp.status == 'active' %}
              {% if can_register %}
                <form method="post" action="{% url 'enroll_olympiad' pk=olymp.pk %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-1"></i>Зарегистрироваться
                  </button>
                </form>
              {% else %}
                {% if user.is_authenticated %}
                  <div class="alert alert-warning mb-0 py-2">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Только студенты могут регистрироваться на соревнования
                  </div>
                {% else %}
                  <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-primary">
                    <i class="bi bi-box-arrow-in-right me-1"></i>Войти для регистрации
                  </a>
                {% endif %}
              {% endif %}
            {% else %}
              <div class="alert alert-secondary mb-0 py-2">
                <i class="bi bi-info-circle me-1"></i>
                Соревнование завершено, регистрация закрыта
              </div>
            {% endif %}
          {% endif %}
          
          {% if olymp.status != 'upcoming' %}
            <a href="{% url 'scoreboard' pk=olymp.pk %}" class="btn btn-outline-primary ms-2">
              <i class="bi bi-trophy me-1"></i>Результаты
            </a>
          {% endif %}
          
          {% if user.is_authenticated and olymp.creator == user %}
            <a href="{% url 'scoreboard' pk=olymp.pk %}" class="btn btn-outline-warning ms-2">
              <i class="bi bi-clipboard-check me-1"></i>Проверка
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card border-0 shadow-sm olymp-info-sidebar">
      <div class="card-body p-4">
        <h4 class="fw-bold mb-4">
          <i class="bi bi-info-circle me-2 text-primary"></i>Информация
        </h4>
        
        <div class="d-flex align-items-center mb-3">
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" 
               style="width: 36px; height: 36px;">
            <i class="bi bi-person"></i>
          </div>
          <div>
            <div class="small text-muted">Организатор</div>
            <div class="fw-medium">{{ olymp.creator.username }}</div>
          </div>
        </div>
        
        <div class="d-flex align-items-center mb-3">
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" 
               style="width: 36px; height: 36px;">
            <i class="bi bi-people"></i>
          </div>
          <div>
            <div class="small text-muted">Участники</div>
            <div class="fw-medium">{{ participants.count }}</div>
          </div>
        </div>
        
        <div class="d-flex align-items-center mb-3">
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" 
               style="width: 36px; height: 36px;">
            <i class="bi bi-clock"></i>
          </div>
          <div>
            <div class="small text-muted">Продолжительность</div>
            <div class="fw-medium">{{ duration_hours }} ч {{ duration_minutes }} мин</div>
          </div>
        </div>
        
        <div class="d-flex align-items-center mb-4">
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" 
               style="width: 36px; height: 36px;">
            <i class="bi bi-list-task"></i>
          </div>
          <div>
            <div class="small text-muted">Количество заданий</div>
            <div class="fw-medium">{{ olymp.problems.count }}</div>
          </div>
        </div>
        
        <!-- Таймер для предстоящих или активных соревнований -->
        {% if olymp.status != 'closed' %}
        <div class="card bg-light border-0 mb-3">
          <div class="card-body p-3">
            <h6 class="fw-semibold text-center mb-2">
              {% if olymp.status == 'upcoming' %}
              <i class="bi bi-hourglass me-1 text-warning"></i>До начала
              {% else %}
              <i class="bi bi-hourglass-split me-1 text-danger"></i>До завершения
              {% endif %}
            </h6>
            
            <div class="d-flex justify-content-between text-center">
              <div>
                <div class="fw-bold fs-5" id="days">--</div>
                <div class="small text-muted">Дней</div>
              </div>
              <div>
                <div class="fw-bold fs-5" id="hours">--</div>
                <div class="small text-muted">Часов</div>
              </div>
              <div>
                <div class="fw-bold fs-5" id="minutes">--</div>
                <div class="small text-muted">Минут</div>
              </div>
              <div>
                <div class="fw-bold fs-5" id="seconds">--</div>
                <div class="small text-muted">Секунд</div>
              </div>
            </div>
          </div>
        </div>
        
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            {% if olymp.status == 'upcoming' %}
            var targetDate = new Date("{{ olymp.start_at|date:'c' }}");
            {% else %}
            var targetDate = new Date("{{ olymp.end_at|date:'c' }}");
            {% endif %}
            
            function updateTimer() {
              var now = new Date();
              var diff = targetDate - now;
              
              if (diff <= 0) {
                document.getElementById('days').textContent = '0';
                document.getElementById('hours').textContent = '0';
                document.getElementById('minutes').textContent = '0';
                document.getElementById('seconds').textContent = '0';
                return;
              }
              
              var days = Math.floor(diff / (1000 * 60 * 60 * 24));
              var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
              var seconds = Math.floor((diff % (1000 * 60)) / 1000);
              
              document.getElementById('days').textContent = days;
              document.getElementById('hours').textContent = hours;
              document.getElementById('minutes').textContent = minutes;
              document.getElementById('seconds').textContent = seconds;
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
          });
        </script>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
