{% extends 'base.html' %}
{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  .stat-card {
    transition: all 0.3s;
  }
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
  }
  .chart-container {
    width: 100%;
    height: 300px;
  }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-decoration-none">Главная</a></li>
    <li class="breadcrumb-item active">Панель администратора</li>
  </ol>
</nav>

<div class="row mb-4">
  <div class="col-md-6">
    <h2 class="fw-bold mb-0">
      <i class="bi bi-speedometer2 me-2 text-primary"></i>Панель администратора
    </h2>
  </div>
  <div class="col-md-6 text-md-end">
    <a href="/admin/" class="btn btn-outline-secondary" target="_blank">
      <i class="bi bi-gear me-1"></i>Django-админка
    </a>
  </div>
</div>

<!-- Статистика -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100 stat-card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
            <i class="bi bi-people fs-4 text-primary"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Пользователи</h6>
            <h3 class="fw-bold mb-0">{{ users_count }}</h3>
          </div>
        </div>
        <a href="{% url 'user_list' %}" class="btn btn-sm btn-primary w-100">
          <i class="bi bi-list me-1"></i>Управление
        </a>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100 stat-card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
            <i class="bi bi-trophy fs-4 text-success"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Соревнования</h6>
            <h3 class="fw-bold mb-0">{{ olympiads_count }}</h3>
          </div>
        </div>
        <a href="{% url 'index' %}" class="btn btn-sm btn-success w-100">
          <i class="bi bi-list me-1"></i>Перейти
        </a>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100 stat-card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="bg-info bg-opacity-10 rounded-3 p-3 me-3">
            <i class="bi bi-file-earmark-text fs-4 text-info"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Задания</h6>
            <h3 class="fw-bold mb-0">{{ problems_count }}</h3>
          </div>
        </div>
        <a href="#problems" class="btn btn-sm btn-info w-100 text-white">
          <i class="bi bi-list me-1"></i>Просмотр
        </a>
      </div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="card border-0 shadow-sm h-100 stat-card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="bg-warning bg-opacity-10 rounded-3 p-3 me-3">
            <i class="bi bi-upload fs-4 text-warning"></i>
          </div>
          <div>
            <h6 class="text-muted mb-1">Решения</h6>
            <h3 class="fw-bold mb-0">{{ submissions_count }}</h3>
          </div>
        </div>
        <a href="#submissions" class="btn btn-sm btn-warning w-100">
          <i class="bi bi-list me-1"></i>Просмотр
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Графики и аналитика -->
<div class="row g-4 mb-4">
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
        <h5 class="fw-bold mb-0">
          <i class="bi bi-bar-chart-fill me-2 text-primary"></i>Статистика олимпиад
        </h5>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Последние 30 дней
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Последние 7 дней</a></li>
            <li><a class="dropdown-item" href="#">Последние 30 дней</a></li>
            <li><a class="dropdown-item" href="#">Последние 90 дней</a></li>
            <li><a class="dropdown-item" href="#">За все время</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <div id="olympiads-status-chart" class="chart-container"></div>
      </div>
    </div>
  </div>
  
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
        <h5 class="fw-bold mb-0">
          <i class="bi bi-pie-chart-fill me-2 text-success"></i>Активность пользователей
        </h5>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Последние 30 дней
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">Последние 7 дней</a></li>
            <li><a class="dropdown-item" href="#">Последние 30 дней</a></li>
            <li><a class="dropdown-item" href="#">Последние 90 дней</a></li>
            <li><a class="dropdown-item" href="#">За все время</a></li>
          </ul>
        </div>
      </div>
      <div class="card-body">
        <div id="user-activity-chart" class="chart-container"></div>
      </div>
    </div>
  </div>
</div>

<!-- Мониторинг системы -->
<div class="row g-4 mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 py-3">
        <h5 class="fw-bold mb-0">
          <i class="bi bi-cpu me-2 text-danger"></i>Мониторинг системы
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-3">
            <div class="card h-100 bg-light border-0">
              <div class="card-body p-3 text-center">
                <div class="display-6 mb-2">
                  <i class="bi bi-cpu text-primary"></i>
                </div>
                <h6 class="fw-bold">Загрузка CPU</h6>
                <div class="display-6 fw-bold text-primary">12%</div>
                <div class="progress mt-3">
                  <div class="progress-bar" role="progressbar" style="width: 12%" aria-valuenow="12" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card h-100 bg-light border-0">
              <div class="card-body p-3 text-center">
                <div class="display-6 mb-2">
                  <i class="bi bi-memory text-success"></i>
                </div>
                <h6 class="fw-bold">Использование памяти</h6>
                <div class="display-6 fw-bold text-success">42%</div>
                <div class="progress mt-3">
                  <div class="progress-bar bg-success" role="progressbar" style="width: 42%" aria-valuenow="42" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card h-100 bg-light border-0">
              <div class="card-body p-3 text-center">
                <div class="display-6 mb-2">
                  <i class="bi bi-hdd text-warning"></i>
                </div>
                <h6 class="fw-bold">Дисковое пространство</h6>
                <div class="display-6 fw-bold text-warning">68%</div>
                <div class="progress mt-3">
                  <div class="progress-bar bg-warning" role="progressbar" style="width: 68%" aria-valuenow="68" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card h-100 bg-light border-0">
              <div class="card-body p-3 text-center">
                <div class="display-6 mb-2">
                  <i class="bi bi-speedometer text-danger"></i>
                </div>
                <h6 class="fw-bold">Запросы в секунду</h6>
                <div class="display-6 fw-bold text-danger">23</div>
                <div class="progress mt-3">
                  <div class="progress-bar bg-danger" role="progressbar" style="width: 23%" aria-valuenow="23" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Блок управления пользователями -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
        <h5 class="fw-bold mb-0">
          <i class="bi bi-people me-2 text-primary"></i>Пользователи
        </h5>
        <a href="{% url 'user_create' %}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-lg me-1"></i>Добавить пользователя
        </a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Имя пользователя</th>
                <th>Роль</th>
                <th>Email</th>
                <th class="text-end">Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for user in recent_users %}
              <tr>
                <td class="align-middle">{{ user.username }}</td>
                <td class="align-middle">
                  {% if user.profile.is_student %}
                    <span class="badge bg-info">Студент</span>
                  {% elif user.profile.is_teacher %}
                    <span class="badge bg-warning">Преподаватель</span>
                  {% elif user.profile.is_admin %}
                    <span class="badge bg-danger">Администратор</span>
                  {% endif %}
                </td>
                <td class="align-middle">{{ user.email }}</td>
                <td class="align-middle text-end">
                  <a href="{% url 'user_edit' user.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center py-3">Пользователи не найдены</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div class="text-center mt-3">
          <a href="{% url 'user_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-list-ul me-1"></i>Все пользователи
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Блок управления соревнованиями -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
        <h5 class="fw-bold mb-0">
          <i class="bi bi-trophy me-2 text-success"></i>Соревнования
        </h5>
        <a href="{% url 'olymp_create' %}" class="btn btn-success btn-sm">
          <i class="bi bi-plus-lg me-1"></i>Создать соревнование
        </a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Название</th>
                <th>Статус</th>
                <th>Организатор</th>
                <th class="text-end">Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for olympiad in recent_olympiads %}
              <tr>
                <td class="align-middle">{{ olympiad.title }}</td>
                <td class="align-middle">
                  {% if olympiad.status == 'active' %}
                    <span class="badge bg-success">Активно</span>
                  {% elif olympiad.status == 'upcoming' %}
                    <span class="badge bg-warning">Скоро</span>
                  {% else %}
                    <span class="badge bg-secondary">Завершено</span>
                  {% endif %}
                </td>
                <td class="align-middle">{{ olympiad.creator.username }}</td>
                <td class="align-middle text-end">
                  <a href="{% url 'olymp_detail' olympiad.pk %}" class="btn btn-sm btn-outline-primary me-1">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{% url 'olymp_edit' olympiad.pk %}" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-pencil"></i>
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center py-3">Соревнования не найдены</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <div class="text-center mt-3">
          <a href="{% url 'index' %}" class="btn btn-outline-success">
            <i class="bi bi-list-ul me-1"></i>Все соревнования
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Блок настроек системы -->
  <div class="col-12">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-transparent border-0 py-3">
        <h5 class="fw-bold mb-0">
          <i class="bi bi-gear me-2 text-secondary"></i>Системные действия
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="fw-semibold">Обновление статусов соревнований</h6>
                <p class="small text-muted">Запустить обновление статусов всех соревнований в зависимости от текущего времени</p>
                <form action="{% url 'update_olympiad_statuses' %}" method="post">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-arrow-clockwise me-1"></i>Обновить статусы
                  </button>
                </form>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="fw-semibold">Резервное копирование</h6>
                <p class="small text-muted">Создать резервную копию базы данных и загруженных файлов</p>
                <a href="#" class="btn btn-primary btn-sm">
                  <i class="bi bi-download me-1"></i>Создать резервную копию
                </a>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="fw-semibold">Настройки системы</h6>
                <p class="small text-muted">Изменить глобальные настройки платформы</p>
                <a href="#" class="btn btn-primary btn-sm">
                  <i class="bi bi-gear me-1"></i>Настройки
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Статистика олимпиад по статусам
  var olympiadStatusData = [{
    values: [{{ active_count }}, {{ upcoming_count }}, {{ closed_count }}],
    labels: ['Активные', 'Предстоящие', 'Завершенные'],
    type: 'pie',
    hole: 0.4,
    marker: {
      colors: ['#198754', '#ffc107', '#6c757d']
    },
    textinfo: 'label+percent',
    insidetextorientation: 'radial'
  }];
  
  var olympiadStatusLayout = {
    title: 'Распределение олимпиад по статусам',
    margin: {l: 0, r: 0, b: 30, t: 40, pad: 0},
    showlegend: false,
    annotations: [{
      text: 'Всего: {{ olympiads_count }}',
      showarrow: false,
      font: {size: 14}
    }]
  };
  
  Plotly.newPlot('olympiads-status-chart', olympiadStatusData, olympiadStatusLayout, {responsive: true});
  
  // Активность пользователей
  var userActivityData = [{
    x: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
    y: [21, 18, 35, 29, 43, 15, 10],
    type: 'bar',
    marker: {
      color: 'rgba(0, 123, 255, 0.7)'
    }
  }];
  
  var userActivityLayout = {
    title: 'Активность пользователей по дням недели',
    margin: {l: 40, r: 0, b: 30, t: 40, pad: 0},
    xaxis: {
      title: 'День недели'
    },
    yaxis: {
      title: 'Количество действий'
    }
  };
  
  Plotly.newPlot('user-activity-chart', userActivityData, userActivityLayout, {responsive: true});
</script>
{% endblock %} 