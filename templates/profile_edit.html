{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'index' %}" class="text-decoration-none">Главная</a></li>
    <li class="breadcrumb-item"><a href="{% url 'profile' %}" class="text-decoration-none">Мой профиль</a></li>
    <li class="breadcrumb-item active">Редактирование профиля</li>
  </ol>
</nav>

<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-4">
        <h2 class="fw-bold mb-4">
          <i class="bi bi-person-gear me-2 text-primary"></i>Редактирование профиля
        </h2>
        
        {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Пожалуйста, исправьте следующие ошибки:</strong>
          <ul>
            {% for field in form %}
              {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data" id="profile-form">
          {% csrf_token %}
          
          <!-- Скрытое поле с текущей ролью пользователя -->
          <input type="hidden" name="role" value="{{ user.profile.role }}">
          
          <div class="mb-4">
            <h5 class="fw-semibold mb-3">Основная информация</h5>
            
            <!-- Аватар -->
            <div class="mb-4">
              <label for="{{ form.avatar.id_for_label }}" class="form-label fw-medium">{{ form.avatar.label }}</label>
              <div class="input-group mb-2">
                {{ form.avatar|add_class:"form-control" }}
              </div>
              {% if form.avatar.errors %}
                <div class="invalid-feedback d-block">{{ form.avatar.errors }}</div>
              {% endif %}
              {% if user.profile.avatar %}
                <div class="mt-2">
                  <img src="{{ user.profile.avatar.url }}?t={{ user.profile.avatar.name|default:''|urlencode }}" alt="Avatar" class="rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
                </div>
              {% endif %}
              <small class="form-text text-muted">Изображение будет автоматически обрезано до квадратного формата. Рекомендуемый размер: 200x200 пикселей.</small>
            </div>
            
            <!-- О себе -->
            <div class="mb-3">
              <label for="{{ form.bio.id_for_label }}" class="form-label fw-medium">{{ form.bio.label }}</label>
              {{ form.bio|add_class:"form-control" }}
              {% if form.bio.errors %}
                <div class="invalid-feedback d-block">{{ form.bio.errors }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="mb-4">
            <h5 class="fw-semibold mb-3">Контактные данные</h5>
            
            <!-- Телефон -->
            <div class="mb-3">
              <label for="{{ form.phone.id_for_label }}" class="form-label fw-medium">{{ form.phone.label }}</label>
              {{ form.phone|add_class:"form-control" }}
              {% if form.phone.errors %}
                <div class="invalid-feedback d-block">{{ form.phone.errors }}</div>
              {% endif %}
            </div>
            
            <!-- Организация -->
            <div class="mb-3">
              <label for="{{ form.organization.id_for_label }}" class="form-label fw-medium">{{ form.organization.label }}</label>
              {{ form.organization|add_class:"form-control" }}
              {% if form.organization.errors %}
                <div class="invalid-feedback d-block">{{ form.organization.errors }}</div>
              {% endif %}
            </div>
            
            <!-- Должность/Группа -->
            <div class="mb-3">
              <label for="{{ form.position.id_for_label }}" class="form-label fw-medium">{{ form.position.label }}</label>
              {{ form.position|add_class:"form-control" }}
              {% if form.position.errors %}
                <div class="invalid-feedback d-block">{{ form.position.errors }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="mb-4">
            <h5 class="fw-semibold mb-3">Дополнительно</h5>
            
            <!-- Дополнительная информация -->
            <div class="mb-3">
              <label for="{{ form.additional_info.id_for_label }}" class="form-label fw-medium">{{ form.additional_info.label }}</label>
              {{ form.additional_info|add_class:"form-control" }}
              {% if form.additional_info.errors %}
                <div class="invalid-feedback d-block">{{ form.additional_info.errors }}</div>
              {% endif %}
            </div>
            
            {% if user.profile.is_admin %}
            <!-- Роль (только для админов) -->
            <div class="mb-3">
              <label for="{{ form.role.id_for_label }}" class="form-label fw-medium">{{ form.role.label }}</label>
              {{ form.role|add_class:"form-select" }}
              {% if form.role.errors %}
                <div class="invalid-feedback d-block">{{ form.role.errors }}</div>
              {% endif %}
              <small class="form-text text-muted">
                Как администратор, вы можете изменить свою роль, но рекомендуется оставить роль Администратора.
              </small>
            </div>
            {% endif %}
          </div>
          
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-1"></i>Сохранить изменения
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} 